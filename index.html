<!DOCTYPE html>
<html>
  <head>
    <title>Fox 91.4 Desktop Client</title>   
    
    <link rel="stylesheet" href="libs/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="libs/fox-desktop/site.css">
    <link rel="stylesheet" type="text/css" href="node_modules/toastr/build/toastr.css">
  </head>
  <body class="body_background">
    <div class="heading">
        <h1 id="heading" align="center">Fox 91.4</h1>
    </div>
    <audio id="audio">
        <source src="" type="audio/mpeg" />
    </audio>
        
    <div id="container_button">
        <div id="hole">
            <div id="button">
                <div id="triangle"></div>
                <div id="lighter_triangle"></div>
                <div id="darker_triangle"></div>
            </div>
        </div>
    </div> 
    
    <div id="menu" class="menu colorAnimatedFont">About</div>   
        
    <script type="application/javascript">
        var $ = require('jquery');
        var jQuery = $;
        
        $(document).ready(function () {            
            
            var toastr = require('toastr');    
            toastr.options.preventDuplicates = true;
            toastr.options.positionClass = "toast-bottom-right";

            //https://drive.google.com/uc?export=download&id=0B1FTb0VQ85FHc1dBM2xCMm9EdE0
            var btnPlay = document.getElementById('button');
            var audio = document.getElementById('audio');
            var heading = document.getElementById("heading");  
            var menu = document.getElementById("menu");  
            var controlTipsShown = false;
            var streamUrl = null;
            var q = require('q');
            var localConfig = require('./local-config.js');
            
            q.Promise(function(resolve, reject){
                var restClient = require('simple-get');            
                restClient.concat(localConfig.remoteConfigUrl, function (err, res, data) {
                    try{
                        if (typeof err === 'undefined' || err === null) {
                            let remoteConfig = JSON.parse(data.toString('utf8'));
                            if(typeof remoteConfig !== 'undefined' && remoteConfig !== null && typeof remoteConfig.streamUrl !== 'undefined' && remoteConfig.streamUrl !== null){
                                resolve({ isSuccess: true, streamUrl: remoteConfig.streamUrl});
                                return;
                            }
                        }
                                       
                        resolve({ isSuccess: false, streamUrl: localConfig.fallbackStreamUrl });
                    }
                    catch(e){                                         
                        resolve({ isSuccess: false, streamUrl: localConfig.fallbackStreamUrl });
                    }
                });
            }).then(function (remoteStreamUrlResult) {
                streamUrl = remoteStreamUrlResult.streamUrl;

                if(!remoteStreamUrlResult.isSuccess){
                    toastr["warning"]("Unable to retrieve remote stream url setting. Using fallback stream url instead...");
                }

                $.fn.extend({
                    animateCss: function (animationName, loop) {
                        var animationEnd = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
                        if(loop){
                            $(this).addClass('animated ' + animationName);    
                        }
                        else{
                            $(this).addClass('animated ' + animationName).one(animationEnd, function() {
                                $(this).removeClass('animated ' + animationName);
                            });
                        }
                    }
                });
                
                var backgroundChangeHandle = null;
                var bgImageNumber = 2;
                btnPlay.addEventListener('click', function() {
                    if(audio.src !== streamUrl){        
                        audio.src = streamUrl;
                        audio.load();
                        audio.play();

                        if(!controlTipsShown){                        
                            toastr["info"]("Hit the button again to pause. But why would you even...");
                        }
                    }
                    else{ 
                        heading.className = '';               
                        audio.pause();
                        audio.currentTime = 0;
                        audio.src = '';

                        clearInterval(backgroundChangeHandle);
                        document.body.style.backgroundImage = '';

                        if(!controlTipsShown){                        
                            toastr["info"]("You could always hit that button again you know...");
                            controlTipsShown = true;
                        }
                    }
                }, false);
                        
                audio.addEventListener('play', function(){            
                    $(heading).animateCss('pulse', true); 
                });

                audio.addEventListener('playing', function(){            
                    $(heading).animateCss('tada', true);  

                    document.body.style.backgroundImage = 'url("images/visuals/' + bgImageNumber + '.gif")';                
                        backgroundChangeHandle = setInterval(function (){                
                            if(bgImageNumber > 14){
                                bgImageNumber = 1;
                            }
                            document.body.style.backgroundImage = 'url("images/visuals/' + bgImageNumber + '.gif")';
                            bgImageNumber += 1;
                        }, 60000);                
                });

                audio.addEventListener('error', function(){
                    if(audio.src === streamUrl){
                        toastr["error"]("Oops! Unable to connect. Please check whether you are properly connected to the internet. If you are, then you may be behind a firewall which is blocking the Fox 91.4 audio stream. That's not cool man. Not cool at all.");
                    }
                });

                menu.addEventListener('click', function(){
                    var aboutMessage = '<a target="_blank" href="https://github.com/harindaka/fox-desktop">Fox Desktop v' + localConfig.version + '</a></br>An unofficial cross platform streaming client for Sri Lanka\'s Fox 91.4 FM Radio.</br>This program is free software licensed and distributed under <a target="_blank"  href="http://www.gnu.org/licenses/gpl-3.0.en.html">GNU GPL v3</a> with absolutely no warranties.</br>Developed by <a target="_blank" href="https://www.linkedin.com/in/harindaka">Hemal Harindaka</a>';
                    toastr["info"](aboutMessage);
                });
                
                toastr["info"]("Hit the button to start streaming awesomeness...");

            }).catch(function(e){
                toastr["error"]("Oops! An unhandled error occurred. You may need to restart the application. Error details: " + e.message);
            }).done();            
            
        });    
        
    </script>

  </body>
</html>